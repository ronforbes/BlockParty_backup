var Game=function(){function n(){var n,t;for(this.boardRows=10,this.boardColumns=10,this.boardStartingRow=0,this.blockWidth=10,this.blockHeight=10,this.blockFallDelayDuration=50,this.blockFallDuration=100,this.blockFlashingDuration=1e3,this.blockPopDelayInterval=250,this.blockPoppingDuration=250,this.blockEmptyDelayInterval=250,this.selectedBlockRow=-1,this.selectedBlockColumn=-1,this.board=[],n=0;n<this.boardRows;n++)for(this.board[n]=[],t=0;t<this.boardColumns;t++)this.board[n][t]=new Block,n<this.boardStartingRow?this.board[n][t].State=BlockState.Empty:(this.board[n][t].State=BlockState.Idle,this.board[n][t].Type=Math.floor(Math.random()*6));this.previousMouseState=Mouse.GetState()}return n.prototype.ProcessInput=function(){var t=Mouse.GetState(),r=Math.floor(t.Y/this.blockHeight),n=Math.floor(t.X/this.blockWidth),i;r>=0&&r<this.boardRows&&n>=0&&n<this.boardColumns&&(t.LeftButton==!0&&this.previousMouseState.LeftButton==!1&&this.board[r][n].State==BlockState.Idle&&(this.selectedBlockRow=r,this.selectedBlockColumn=n),this.selectedBlockRow!=-1&&this.selectedBlockColumn!=-1&&(n<this.selectedBlockColumn&&(this.board[this.selectedBlockRow][this.selectedBlockColumn-1].State==BlockState.Idle||this.board[this.selectedBlockRow][this.selectedBlockColumn-1].State==BlockState.Empty)&&(i=this.board[this.selectedBlockRow][this.selectedBlockColumn-1],this.board[this.selectedBlockRow][this.selectedBlockColumn-1]=this.board[this.selectedBlockRow][this.selectedBlockColumn],this.board[this.selectedBlockRow][this.selectedBlockColumn]=i,this.selectedBlockColumn--),n>this.selectedBlockColumn&&(this.board[this.selectedBlockRow][this.selectedBlockColumn+1].State==BlockState.Idle||this.board[this.selectedBlockRow][this.selectedBlockColumn+1].State==BlockState.Empty)&&(i=this.board[this.selectedBlockRow][this.selectedBlockColumn+1],this.board[this.selectedBlockRow][this.selectedBlockColumn+1]=this.board[this.selectedBlockRow][this.selectedBlockColumn],this.board[this.selectedBlockRow][this.selectedBlockColumn]=i,this.selectedBlockColumn++))),t.LeftButton==!1&&(this.selectedBlockRow=-1,this.selectedBlockColumn=-1),this.previousMouseState=t},n.prototype.DetectMatches=function(){for(var i,u,t,r,f,n=0;n<this.boardRows;n++)for(i=0,t=0;t<this.boardColumns;t++)if(this.board[n][t].State==BlockState.Idle)if(t+1<this.boardColumns&&this.board[n][t+1].State==BlockState.Idle&&this.board[n][t].Type==this.board[n][t+1].Type)i++;else{if(i>=2)for(u=i;u>=0;u--)this.board[n][t-u].State=BlockState.Matched;i=0}for(t=0;t<this.boardColumns;t++)for(r=0,n=0;n<this.boardRows;n++)if(this.board[n][t].State==BlockState.Idle)if(n+1<this.boardRows&&this.board[n+1][t].State==BlockState.Idle&&this.board[n][t].Type==this.board[n+1][t].Type)r++;else{if(r>=2)for(f=r;f>=0;f--)this.board[n-f][t].State=BlockState.Matched;r=0}},n.prototype.ProcessMatchedBlocks=function(){for(var r=0,i,t,n=0;n<this.boardRows;n++)for(t=0;t<this.boardColumns;t++)this.board[n][t].State==BlockState.Matched&&r++;for(i=r,n=0;n<this.boardRows;n++)for(t=0;t<this.boardColumns;t++)this.board[n][t].State==BlockState.Matched&&(this.board[n][t].State=BlockState.Flashing,this.board[n][t].PopDelayDuration=(r-i)*this.blockPopDelayInterval,this.board[n][t].EmptyDelayDuration=i*this.blockEmptyDelayInterval,i--)},n.prototype.ProcessFlashingBlocks=function(n){for(var i,t=0;t<this.boardRows;t++)for(i=0;i<this.boardColumns;i++)this.board[t][i].State==BlockState.Flashing&&(this.board[t][i].FlashingTimer+=n,this.board[t][i].FlashingTimer>=this.blockFlashingDuration&&(this.board[t][i].FlashingTimer=0,this.board[t][i].State=BlockState.WaitingToPop))},n.prototype.ProcessWaitingToPopBlocks=function(n){for(var i,t=0;t<this.boardRows;t++)for(i=0;i<this.boardColumns;i++)this.board[t][i].State==BlockState.WaitingToPop&&(this.board[t][i].PopDelayTimer+=n,this.board[t][i].PopDelayTimer>=this.board[t][i].PopDelayDuration&&(this.board[t][i].PopDelayTimer=0,this.board[t][i].PopDelayDuration=0,this.board[t][i].State=BlockState.Popping))},n.prototype.ProcessPoppingBlocks=function(n){for(var i,t=0;t<this.boardRows;t++)for(i=0;i<this.boardColumns;i++)this.board[t][i].State==BlockState.Popping&&(this.board[t][i].PopTimer+=n,this.board[t][i].PopTimer>=this.blockPoppingDuration&&(this.board[t][i].PopTimer=0,this.board[t][i].State=BlockState.WaitingToEmpty))},n.prototype.ProcessWaitingToEmptyBlocks=function(n){for(var i,t=0;t<this.boardRows;t++)for(i=0;i<this.boardColumns;i++)this.board[t][i].State==BlockState.WaitingToEmpty&&(this.board[t][i].EmptyDelayTimer+=n,this.board[t][i].EmptyDelayTimer>=this.board[t][i].EmptyDelayDuration&&(this.board[t][i].EmptyDelayTimer=0,this.board[t][i].EmptyDelayDuration=0,this.board[t][i].State=BlockState.Empty))},n.prototype.ProcessGravity=function(){for(var i,t,n=0;n<this.boardColumns;n++)for(i=!1,t=this.boardRows-1;t>=0;t--)this.board[t][n].State==BlockState.Empty&&(i=!0),this.board[t][n].State==BlockState.Idle&&i&&(this.board[t][n].State=BlockState.WaitingToFall)},n.prototype.ProcessWaitingToFallBlocks=function(n){for(var i,t=0;t<this.boardRows;t++)for(i=0;i<this.boardColumns;i++)this.board[t][i].State==BlockState.WaitingToFall&&(this.board[t][i].FallDelayTimer+=n,this.board[t][i].FallDelayTimer>=this.blockFallDelayDuration&&(this.board[t][i].FallDelayTimer=0,this.board[t][i].State=BlockState.Falling))},n.prototype.ProcessFallingBlocks=function(n){for(var t,i=0;i<this.boardColumns;i++)for(t=this.boardRows-1;t>=0;t--)this.board[t][i].State==BlockState.Falling&&(t+1<this.boardRows&&(this.board[t+1][i].State==BlockState.Empty||this.board[t+1][i].State==BlockState.Falling)?this.board[t][i].FallTimer>=this.blockFallDuration?(this.board[t][i].FallTimer=0,this.board[t+1][i].Type=this.board[t][i].Type,this.board[t+1][i].State=BlockState.Falling,this.board[t][i].State=BlockState.Empty):this.board[t][i].FallTimer+=n:this.board[t][i].State=BlockState.Idle)},n.prototype.DrawBoard=function(){for(var r,t,n,i=0;i<this.boardRows;i++)for(r=0;r<this.boardColumns;r++){switch(this.board[i][r].Type){case BlockType.A:t="red";break;case BlockType.B:t="green";break;case BlockType.C:t="blue";break;case BlockType.D:t="cyan";break;case BlockType.E:t="magenta";break;case BlockType.F:t="yellow"}switch(this.board[i][r].State){case BlockState.Empty:t="black",n="E";break;case BlockState.Idle:n="I";break;case BlockState.WaitingToFall:n="WF";break;case BlockState.Falling:n="Fall";break;case BlockState.Matched:n="M";break;case BlockState.Flashing:n="Flash";break;case BlockState.WaitingToPop:n="WP";break;case BlockState.Popping:n="P";break;case BlockState.WaitingToEmpty:t="black",n="WE"}Graphics.DrawRectangle(new Vector2(r*this.blockWidth,i*this.blockHeight),this.blockWidth,this.blockHeight,5,"black",t),Graphics.DrawText(n,new Vector2(r*this.blockWidth+this.blockWidth/2,i*this.blockHeight+this.blockHeight/2),"white")}},n.prototype.Update=function(n){Graphics.Clear(),this.ProcessInput(),this.ProcessGravity(n),this.ProcessWaitingToFallBlocks(n),this.ProcessFallingBlocks(n),this.DetectMatches(),this.ProcessMatchedBlocks(),this.ProcessFlashingBlocks(n),this.ProcessWaitingToPopBlocks(n),this.ProcessPoppingBlocks(n),this.ProcessWaitingToEmptyBlocks(n),this.DrawBoard(),Graphics.Draw()},n}()