var Board=function(){function n(){var n,t;for(this.slideInProgress=!1,this.slideDirection=0,this.slideTimer=0,this.slideDuration=50,this.selectedRow=-1,this.selectedColumn=-1,this.ROWS=10,this.COLUMNS=10,this.STARTING_ROW=0,this.board=[],n=0;n<this.ROWS;n++)for(this.board[n]=[],t=0;t<this.COLUMNS;t++)this.board[n][t]=new Block,n<this.STARTING_ROW?this.board[n][t].State=BlockState.Empty:(this.board[n][t].State=BlockState.Idle,this.board[n][t].Type=Math.floor(Math.random()*Block.TYPE_COUNT));this.previousMouseState=Mouse.GetState()}return n.prototype.HandleInput=function(){var t=Mouse.GetState(),i=Math.floor(t.Y/Block.HEIGHT),n=Math.floor(t.X/Block.WIDTH);i>=0&&i<this.ROWS&&n>=0&&n<this.COLUMNS&&(t.LeftButton==!0&&this.previousMouseState.LeftButton==!1&&this.board[i][n].State==BlockState.Idle&&(this.selectedRow=i,this.selectedColumn=n),this.selectedRow!=-1&&this.selectedColumn!=-1&&(n<this.selectedColumn&&this.board[this.selectedRow][this.selectedColumn].State==BlockState.Idle&&(this.board[this.selectedRow][this.selectedColumn-1].State==BlockState.Idle||this.board[this.selectedRow][this.selectedColumn-1].State==BlockState.Empty)&&(this.slideInProgress=!0,this.slideDirection=-1),n>this.selectedColumn&&this.board[this.selectedRow][this.selectedColumn].State==BlockState.Idle&&(this.board[this.selectedRow][this.selectedColumn+1].State==BlockState.Idle||this.board[this.selectedRow][this.selectedColumn+1].State==BlockState.Empty)&&(this.slideInProgress=!0,this.slideDirection=1))),t.LeftButton==!1&&(this.selectedRow=-1,this.selectedColumn=-1),this.previousMouseState=t},n.prototype.HandleSlidingBlocks=function(n){if(this.slideInProgress==!0&&(this.slideTimer+=n,this.slideTimer>=this.slideDuration)){this.slideTimer=0;var t=this.board[this.selectedRow][this.selectedColumn+this.slideDirection];this.board[this.selectedRow][this.selectedColumn+this.slideDirection]=this.board[this.selectedRow][this.selectedColumn],this.board[this.selectedRow][this.selectedColumn]=t,this.selectedColumn+=this.slideDirection,this.slideInProgress=!1,this.slideDirection=0}},n.prototype.DetectMatches=function(){for(var i,u,t,r,f,n=0;n<this.ROWS;n++)for(i=0,t=0;t<this.COLUMNS;t++)if(this.board[n][t].State==BlockState.Idle)if(t+1<this.COLUMNS&&this.board[n][t+1].State==BlockState.Idle&&this.board[n][t].Type==this.board[n][t+1].Type)i++;else{if(i>=2)for(u=i;u>=0;u--)this.board[n][t-u].State=BlockState.Matched;i=0}for(t=0;t<this.COLUMNS;t++)for(r=0,n=0;n<this.ROWS;n++)if(this.board[n][t].State==BlockState.Idle)if(n+1<this.ROWS&&this.board[n+1][t].State==BlockState.Idle&&this.board[n][t].Type==this.board[n+1][t].Type)r++;else{if(r>=2)for(f=r;f>=0;f--)this.board[n-f][t].State=BlockState.Matched;r=0}},n.prototype.ProcessMatchedBlocks=function(){for(var r=0,i,t,n=0;n<this.ROWS;n++)for(t=0;t<this.COLUMNS;t++)this.board[n][t].State==BlockState.Matched&&r++;for(i=r,n=0;n<this.ROWS;n++)for(t=0;t<this.COLUMNS;t++)this.board[n][t].State==BlockState.Matched&&(this.board[n][t].State=BlockState.Flashing,this.board[n][t].PopDelayDuration=(r-i)*Block.POP_DELAY_INTERVAL,this.board[n][t].EmptyDelayDuration=i*Block.EMPTY_DELAY_INTERVAL,i--)},n.prototype.ApplyGravity=function(n){for(var r,t,i=0;i<this.COLUMNS;i++)for(r=!1,t=this.ROWS-1;t>=0;t--)this.board[t][i].State==BlockState.Empty&&(r=!0),this.board[t][i].State==BlockState.Idle&&r&&(this.board[t][i].State=BlockState.WaitingToFall),this.board[t][i].State==BlockState.Falling&&(t+1<this.ROWS&&(this.board[t+1][i].State==BlockState.Empty||this.board[t+1][i].State==BlockState.Falling)?this.board[t][i].FallTimer>=Block.FALL_DURATION?(this.board[t][i].FallTimer=0,this.board[t+1][i].Type=this.board[t][i].Type,this.board[t+1][i].State=BlockState.Falling,this.board[t][i].State=BlockState.Empty):this.board[t][i].FallTimer+=n:this.board[t][i].State=BlockState.Idle)},n.prototype.UpdateBlocks=function(n){for(var i,t=0;t<this.ROWS;t++)for(i=0;i<this.COLUMNS;i++)this.board[t][i].Update(n)},n.prototype.Draw=function(){for(var t,n,i,u,f,r=0;r<this.ROWS;r++)for(t=0;t<this.COLUMNS;t++){u=0,f=0;switch(this.board[r][t].Type){case BlockType.A:n="red";break;case BlockType.B:n="green";break;case BlockType.C:n="blue";break;case BlockType.D:n="cyan";break;case BlockType.E:n="magenta";break;case BlockType.F:n="yellow"}switch(this.board[r][t].State){case BlockState.Empty:n="#000000",i="E";continue;case BlockState.Idle:i="I";break;case BlockState.WaitingToFall:i="WF";break;case BlockState.Falling:i="Fall",f=this.board[r][t].FallTimer*Block.HEIGHT/Block.FALL_DURATION;break;case BlockState.Matched:i="M";break;case BlockState.Flashing:Date.now()%100>50&&(n="white"),i="Flash";break;case BlockState.WaitingToPop:i="WP";break;case BlockState.Popping:i="P";break;case BlockState.WaitingToEmpty:n="black",i="WE"}this.slideInProgress==!0&&r==this.selectedRow&&(t==this.selectedColumn&&(u=this.slideTimer*Block.WIDTH/this.slideDuration*this.slideDirection),t==this.selectedColumn+this.slideDirection&&(u=-1*this.slideTimer*Block.WIDTH/this.slideDuration*this.slideDirection)),Graphics.DrawRectangle(new Vector2(t*Block.WIDTH+u,r*Block.HEIGHT+f),Block.WIDTH,Block.HEIGHT,1,"black",n)}},n.prototype.Update=function(n){this.HandleInput(),this.HandleSlidingBlocks(n),this.DetectMatches(),this.ProcessMatchedBlocks(),this.ApplyGravity(n),this.UpdateBlocks(n),this.Draw(n)},n}()