var Board=function(){function n(){var t,n;for(this.Score=0,this.slideInProgress=!1,this.slideDirection=0,this.slideTimer=0,this.slideDuration=50,this.chainCount=1,this.raiseStack=!1,this.riseTimer=0,this.riseDuration=1e4,this.riseForcedRate=15,this.loseTimer=0,this.loseDuration=1e4,this.lost=!1,this.selectedRow=-1,this.selectedColumn=-1,this.ROWS=10,this.COLUMNS=6,this.STARTING_ROW=5,this.SCORE_FORCED_RISE=1,this.board=[],t=0;t<this.ROWS;t++)for(this.board[t]=[],n=0;n<this.COLUMNS;n++)this.board[t][n]=new Block,t<this.STARTING_ROW?this.board[t][n].State=BlockState.Empty:(this.board[t][n].State=BlockState.Idle,this.board[t][n].Type=Math.floor(Math.random()*Block.TYPE_COUNT));for(this.newRow=[],n=0;n<this.COLUMNS;n++)this.newRow[n]=new Block,this.newRow[n].State=BlockState.Idle,this.newRow[n].Type=Math.floor(Math.random()*Block.TYPE_COUNT);this.previousMouseState=Mouse.GetState()}return n.prototype.HandleInput=function(n){var t=Mouse.GetState(),r=Math.floor((BlockRenderer.Height*this.riseTimer/this.riseDuration+t.Y)/BlockRenderer.Height),i=Math.floor(t.X/BlockRenderer.Width),u;r>=0&&r<this.ROWS&&i>=0&&i<this.COLUMNS&&(t.LeftButton==!0&&this.previousMouseState.LeftButton==!1&&(u=Date.now()-this.previousClickTime,u<=Mouse.DoubleClickDelay?Math.sqrt(Math.pow(Math.abs(t.X-this.previousMouseState.X),2)+Math.pow(Math.abs(t.Y-this.previousMouseState.Y),2))<10&&(this.raiseStack=!0):this.raiseStack=!1,this.previousClickTime=Date.now(),this.board[r][i].State==BlockState.Idle&&(this.selectedRow=r,this.selectedColumn=i)),this.selectedRow!=-1&&this.selectedColumn!=-1&&(i<this.selectedColumn&&this.board[this.selectedRow][this.selectedColumn].State==BlockState.Idle&&(this.board[this.selectedRow][this.selectedColumn-1].State==BlockState.Idle||this.board[this.selectedRow][this.selectedColumn-1].State==BlockState.Empty)&&(this.slideInProgress=!0,this.slideDirection=-1),i>this.selectedColumn&&this.board[this.selectedRow][this.selectedColumn].State==BlockState.Idle&&(this.board[this.selectedRow][this.selectedColumn+1].State==BlockState.Idle||this.board[this.selectedRow][this.selectedColumn+1].State==BlockState.Empty)&&(this.slideInProgress=!0,this.slideDirection=1))),t.LeftButton==!1&&(this.selectedRow=-1,this.selectedColumn=-1),this.raiseStack&&(this.riseTimer+=n*this.riseForcedRate,this.Score+=this.SCORE_FORCED_RISE,this.riseTimer>=this.riseDuration&&!t.LeftButton&&(this.raiseStack=!1)),this.previousMouseState=t},n.prototype.HandleSlidingBlocks=function(n){if(this.slideInProgress==!0&&(this.slideTimer+=n,this.slideTimer>=this.slideDuration)){this.slideTimer=0;var t=this.board[this.selectedRow][this.selectedColumn+this.slideDirection];this.board[this.selectedRow][this.selectedColumn+this.slideDirection]=this.board[this.selectedRow][this.selectedColumn],this.board[this.selectedRow][this.selectedColumn]=t,this.selectedColumn+=this.slideDirection,this.slideInProgress=!1,this.slideDirection=0}},n.prototype.DetectMatches=function(){for(var e=!1,i,r,t,u,f,n=0;n<this.ROWS;n++)for(i=0,t=0;t<this.COLUMNS;t++)if(this.board[n][t].State==BlockState.Idle)if(t+1<this.COLUMNS&&this.board[n][t+1].State==BlockState.Idle&&this.board[n][t].Type==this.board[n][t+1].Type)i++;else{if(i>=2)for(r=i;r>=0;r--)this.board[n][t-r].State=BlockState.Matched,this.board[n][t-r].EligibleForChain==!0&&(e=!0);i=0}for(t=0;t<this.COLUMNS;t++)for(u=0,n=0;n<this.ROWS;n++)if(this.board[n][t].State==BlockState.Idle)if(n+1<this.ROWS&&this.board[n+1][t].State==BlockState.Idle&&this.board[n][t].Type==this.board[n+1][t].Type)u++;else{if(u>=2)for(f=u;f>=0;f--)this.board[n-f][t].State=BlockState.Matched,this.board[n-f][t].EligibleForChain==!0&&(e=!0);u=0}e==!0&&this.chainCount++},n.prototype.ProcessMatchedBlocks=function(){for(var i=0,r,t,n=0;n<this.ROWS;n++)for(t=0;t<this.COLUMNS;t++)this.board[n][t].State==BlockState.Matched&&i++;for(r=i,i>3&&(this.Score+=i*100),n=0;n<this.ROWS;n++)for(t=0;t<this.COLUMNS;t++)this.board[n][t].State==BlockState.Matched&&(this.board[n][t].State=BlockState.Flashing,this.board[n][t].PopDelayDuration=(i-r)*Block.POP_DELAY_INTERVAL,this.board[n][t].EmptyDelayDuration=r*Block.EMPTY_DELAY_INTERVAL,r--)},n.prototype.DetectChains=function(){for(var t,i,n=0;n<this.COLUMNS;n++)for(t=this.ROWS-1;t>=0;t--){if(this.board[t][n].JustBecameEmpty==!0)for(i=t-1;i>=0;i--)this.board[i][n].State==BlockState.Idle&&(this.board[i][n].EligibleForChain=!0);this.board[t][n].JustBecameEmpty=!1}},n.prototype.DetectChainStop=function(){for(var i=!0,t,n=0;n<this.ROWS;n++)for(t=0;t<this.COLUMNS;t++)this.board[n][t].State!=BlockState.Idle&&this.board[n][t].State!=BlockState.Empty&&(i=!1);if(i==!0){for(n=0;n<this.ROWS;n++)for(t=0;t<this.COLUMNS;t++)this.board[n][t].EligibleForChain=!1;this.chainCount=1}},n.prototype.ApplyGravity=function(n){for(var r,t,i=0;i<this.COLUMNS;i++)for(r=!1,t=this.ROWS-1;t>=0;t--)this.board[t][i].State==BlockState.Empty&&(r=!0),this.board[t][i].State==BlockState.Idle&&r&&(this.board[t][i].State=BlockState.WaitingToFall),this.board[t][i].State==BlockState.Falling&&(t+1<this.ROWS&&(this.board[t+1][i].State==BlockState.Empty||this.board[t+1][i].State==BlockState.Falling)?this.board[t][i].FallTimer>=Block.FALL_DURATION?(this.board[t][i].FallTimer=0,this.board[t+1][i].Type=this.board[t][i].Type,this.board[t+1][i].State=BlockState.Falling,this.board[t+1][i].EligibleForChain=this.board[t][i].EligibleForChain,this.board[t][i].State=BlockState.Empty,this.board[t][i].EligibleForChain=!1):this.board[t][i].FallTimer+=n:this.board[t][i].State=BlockState.Idle)},n.prototype.RaiseBoard=function(n){for(var r=!0,u=!1,t,i=0;i<this.ROWS;i++)for(t=0;t<this.COLUMNS;t++)i==0&&this.board[i][t].State==BlockState.Idle&&(r=!1,u=!0),this.board[i][t].State!=BlockState.Empty&&this.board[i][t].State!=BlockState.Idle&&(r=!1);if(r&&(this.riseTimer+=n,this.riseTimer>=this.riseDuration)){for(this.riseTimer=0,i=0;i<this.ROWS-1;i++)for(t=0;t<this.COLUMNS;t++)this.board[i][t].State=this.board[i+1][t].State,this.board[i][t].Type=this.board[i+1][t].Type;for(t=0;t<this.COLUMNS;t++)this.board[this.ROWS-1][t].State=this.newRow[t].State,this.board[this.ROWS-1][t].Type=this.newRow[t].Type,this.newRow[t].Type=Math.floor(Math.random()*Block.TYPE_COUNT)}u?(this.loseTimer+=n,this.loseTimer>=this.loseDuration&&(this.lost=!0)):this.loseTimer=0},n.prototype.UpdateBlocks=function(n){for(var i,t=0;t<this.ROWS;t++)for(i=0;i<this.COLUMNS;i++)this.board[t][i].Update(n,this)},n.prototype.Draw=function(){var i,t,n,f,r,u;for(Graphics.DrawFullscreenRectangle("#222222"),i=0;i<this.ROWS;i++)for(t=0;t<this.COLUMNS;t++){r=0,u=0;switch(this.board[i][t].Type){case BlockType.A:n="red";break;case BlockType.B:n="green";break;case BlockType.C:n="blue";break;case BlockType.D:n="cyan";break;case BlockType.E:n="magenta";break;case BlockType.F:n="yellow"}switch(this.board[i][t].State){case BlockState.Empty:n="#000000";break;case BlockState.Falling:u=this.board[i][t].FallTimer*BlockRenderer.Height/Block.FALL_DURATION;break;case BlockState.Flashing:Date.now()%100>50&&(n="white");break;case BlockState.WaitingToEmpty:n="black"}f=this.board[i][t].EligibleForChain==!0?"E":"",this.slideInProgress==!0&&i==this.selectedRow&&(t==this.selectedColumn&&(r=this.slideTimer*BlockRenderer.Width/this.slideDuration*this.slideDirection),t==this.selectedColumn+this.slideDirection&&(r=-1*this.slideTimer*BlockRenderer.Width/this.slideDuration*this.slideDirection)),u-=BlockRenderer.Height*this.riseTimer/this.riseDuration,Graphics.DrawRectangle(new Vector2(t*BlockRenderer.Width+r,i*BlockRenderer.Height+u),BlockRenderer.Width,BlockRenderer.Height,1,"black",n)}for(t=0;t<this.COLUMNS;t++){r=0,u=0;switch(this.newRow[t].Type){case BlockType.A:n="#880000";break;case BlockType.B:n="#008800";break;case BlockType.C:n="#000088";break;case BlockType.D:n="#008888";break;case BlockType.E:n="#880088";break;case BlockType.F:n="#888800"}}this.lost},n.prototype.Update=function(n){this.HandleInput(n),this.HandleSlidingBlocks(n),this.DetectMatches(),this.ProcessMatchedBlocks(),this.DetectChains(),this.DetectChainStop(),this.ApplyGravity(n),this.RaiseBoard(n),this.UpdateBlocks(n),this.Draw(n)},n}()
